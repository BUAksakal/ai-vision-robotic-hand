
# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1z8VacBA9iLBnvmJHEGk1hwd6_F-7BaNL
"""

"""
AI-Based Vision-Controlled Robotic Hand (Graduation Project)
- Camera capture with OpenCV
- Hand tracking with cvzone.HandTrackingModule
- Finger state extraction (thumb/index/middle/ring/pinky)
- Serial communication to Arduino via cvzone.SerialModule
"""

import cv2
import cvzone
from cvzone.HandTrackingModule import HandDetector


def fingers_up(hand: dict, hand_type: str, serial_obj) -> list[int]:
    """
    Computes which fingers are up (1) or down (0) for a detected hand.
    Sends the resulting list via serial.

    Args:
        hand: cvzone hand dict (contains 'lmList' etc.)
        hand_type: 'Right' or 'Left'
        serial_obj: cvzone SerialObject instance

    Returns:
        List of five ints [thumb, index, middle, ring, pinky]
    """
    lm_list = hand["lmList"]

    # Tip IDs: thumb=4, index=8, middle=12, ring=16, pinky=20
    # For index/middle/ring/pinky we compare tip y with pip y (tip above pip => finger up)
    index_up  = int(lm_list[8][1]  < lm_list[6][1])
    middle_up = int(lm_list[12][1] < lm_list[10][1])
    ring_up   = int(lm_list[16][1] < lm_list[14][1])
    pinky_up  = int(lm_list[20][1] < lm_list[18][1])

    # Thumb needs x-comparison because it moves sideways (depends on right/left hand)
    if hand_type == "Right":
        thumb_up = int(lm_list[4][0] > lm_list[3][0])
    else:  # "Left"
        thumb_up = int(lm_list[4][0] < lm_list[3][0])

    fingers = [thumb_up, index_up, middle_up, ring_up, pinky_up]

    # Send to Arduino (cvzone expects a list of numbers)
    try:
        serial_obj.sendData(fingers)
    except Exception as e:
        # Keep running even if serial temporarily fails
        print(f"[WARN] Serial send failed: {e}")

    return fingers


def main():
    # Camera init
    cap = cv2.VideoCapture(0)
    if not cap.isOpened():
        raise RuntimeError("Camera could not be opened. Check camera permission / index.")

    # Set camera resolution
    cap.set(3, 1280)  # width
    cap.set(4, 720)   # height

    # Hand detector
    detector = HandDetector(detectionCon=0.7, maxHands=1)

    # Serial port (IMPORTANT: update COM port for your system)
    # Windows example: "COM4"
    # Linux example: "/dev/ttyACM0" or "/dev/ttyUSB0"
    serial_port = "COM4"
    baud_rate = 9600
    serial_obj = cvzone.SerialModule.SerialObject(serial_port, baud_rate, 1)

    while True:
        success, img = cap.read()
        if not success or img is None:
            print("Kamera görüntüsü okunamıyor.")
            break

        # Find hands
        hands, img = detector.findHands(img, draw=True)

        if hands:
            hand = hands[0]
            hand_type = hand.get("type", "Right")  # 'Right' or 'Left'
            finger_status = fingers_up(hand, hand_type, serial_obj)

            # Print finger status
            # Example: [1,0,1,1,0]
            print(finger_status)

            # Optional: overlay text
            cv2.putText(
                img,
                f"Fingers: {finger_status}",
                (20, 60),
                cv2.FONT_HERSHEY_SIMPLEX,
                1.0,
                (0, 0, 0),
                3,
            )

        cv2.imshow("Image", img)

        # Quit on 'q'
        if cv2.waitKey(1) & 0xFF == ord("q"):
            break

    cap.release()
    cv2.destroyAllWindows()


if __name__ == "__main__":
    main()
